<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="This-That peer-to-peer communication">
	<meta name="author" content="max1220">
	<link rel="icon" type="image/x-icon" href="this_that_favicon.ico">
	<title>Contacts</title>
	<link rel="stylesheet" href="window.css">
	<link rel="stylesheet" href="common.css">
	<style>
		table {
			flex-grow: 1;
			width: 100%;
		}
		table thead tr td {
			position: sticky;
			top: 0;
			font-weight: bold;
			background-color: #ccc;
		}
		table tbody tr.selected {
			background-color: #aaf;
		}
	</style>
</head>
<body data-preferred-window-width="450" data-preferred-window-height="250">
	<nav class="nav">
		<button class="btn-small" onclick="add_contact()">Add concact</button>
		<button class="btn-small" onclick="open_contact()">Edit contact</button>
		<button class="btn-small" onclick="open_profile()">View profile</button>
		<button class="btn-small" onclick="open_chat()">Chat</button>
		<button class="btn-small" onclick="open_call()">Call</button>
	</nav>
	<main>
		<table id="contacts_table">
			<thead>
				<tr>
					<td>Name</td>
					<td>ID</td>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td>Loading, please wait...</td>
					<td></td>
				</tr>
			</tbody>
		</table>
	</main>

	<script src="window_manager_library/WindowClient.js"></script>
	<script src="contacts_list.js"></script>
	<script>
		// get control over this window
		let wm_client = new WindowClient(window.parent)
		wm_client.register_message_handler()

		function add_contact() {
			wm_client.add_window("contact_add.html", {})
		}
		function open_profile() {
			wm_client.add_window("profile.html", { peer_id: selected_contact.peer_id })
		}
		function open_contact() {
			if (!selected_contact) { return; }
			wm_client.add_window("contact_edit.html", { peer_id: selected_contact.peer_id })
		}
		function open_chat() {
			if (!selected_contact) { return; }
			wm_client.add_window("chat.html", { peer_id: selected_contact.peer_id })
		}
		function open_call() {
			if (!selected_contact) { return; }
			wm_client.add_window("call_outgoing.html", { peer_id: selected_contact.peer_id })
		}

		// update the contacts table
		function update_contacts_list() {
			let contacts_table = document.querySelector("#contacts_table tbody")
			// remove old rows
			contacts_table.querySelectorAll("tbody tr").forEach(e => e.remove())
			// add new rows
			let contacts_list_keys = contacts_list.keys()
			contacts_list_keys.sort()
			for (let i=0; i<contacts_list_keys.length; i++) {
				let contact = contacts_list[contacts_list_keys[i]]
				let tr = contacts_table.insertRow()
				tr.insertCell().appendChild(document.createTextNode(contact.name))
				tr.insertCell().appendChild(document.createTextNode(contact.peer_id))
				tr.onclick = () => {
					console.log("selected", contact)
					document.querySelectorAll("tr.selected").forEach(e => e.classList.remove("selected"))
					tr.classList.add("selected")
					selected_contact = contact 
				}
				if (i==0) { tr.onclick(); }
				tr.ondblclick = () => {
					tr.onclick()
					open_chat()
				}
			}
			let first_contact = contacts_list[contacts_list_keys[1]]
		}

		update_contacts_list()
	</script>
</body>
</html>